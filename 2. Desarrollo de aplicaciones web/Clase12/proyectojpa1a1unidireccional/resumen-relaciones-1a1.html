<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relaciones JPA OneToOne (1:1) - Gu√≠a Completa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .section-composicion {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border-left: 5px solid #e74c3c;
        }

        .section-agregacion {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-left: 5px solid #3498db;
        }

        .section-cascade {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-left: 5px solid #f39c12;
        }

        .section-fetch {
            background: linear-gradient(135deg, #e0c3fc 0%, #9bb5ff 100%);
            border-left: 5px solid #9b59b6;
        }

        .section-ejemplos {
            background: linear-gradient(135deg, #c3f0ca 0%, #ffc3a0 100%);
            border-left: 5px solid #27ae60;
        }

        h2 {
            color: #2c3e50;
            font-size: 1.8rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h3 {
            color: #34495e;
            font-size: 1.4rem;
            margin: 20px 0 15px 0;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 5px;
        }

        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
            white-space: pre-line;
            line-height: 1.6;
            font-size: 14px;
        }

        .code-block .comment {
            color: #95a5a6;
            font-style: italic;
        }

        .code-block .annotation {
            color: #e74c3c;
            font-weight: bold;
        }

        .code-block .keyword {
            color: #3498db;
            font-weight: bold;
        }

        .code-line {
            display: block;
            margin: 4px 0;
            padding: 2px 0;
        }

        .code-line:hover {
            background-color: rgba(52, 152, 219, 0.1);
            border-radius: 3px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .comparison-table th,
        .comparison-table td {
            padding: 15px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .comparison-table th {
            background: #34495e;
            color: white;
            font-weight: bold;
        }

        .comparison-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .comparison-table tr:hover {
            background-color: #e8f4fd;
            transform: scale(1.01);
            transition: all 0.3s ease;
        }

        .highlight-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #fdcb6e;
        }

        .success-box {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #28a745;
        }

        .error-box {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #dc3545;
        }

        .emoji {
            font-size: 1.5rem;
        }

        .cascade-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .cascade-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }

        .cascade-item h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .example-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-top: 3px solid #27ae60;
        }

        .example-card h5 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .footer {
            background: #2c3e50;
            color: white;
            text-align: center;
            padding: 30px;
            margin-top: 40px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span class="emoji">üöó</span> Relaciones JPA OneToOne (1:1)</h1>
            <p>Gu√≠a completa sobre asociaciones unidireccionales Auto-Motor</p>
        </div>

        <div class="content">
            <!-- Secci√≥n: Tipos de Asociaciones -->
            <div class="section section-composicion">
                <h2><span class="emoji">üîó</span> Tipos de Asociaciones</h2>
                
                <h3>1. COMPOSICI√ìN (Composition) - "Parte de"</h3>
                <ul>
                    <li><strong>Dependencia fuerte:</strong> El hijo NO puede existir sin el padre</li>
                    <li><strong>Ciclo de vida acoplado:</strong> Si eliminas el padre, se elimina el hijo</li>
                    <li><strong>Propiedad exclusiva:</strong> El hijo pertenece a UN solo padre</li>
                </ul>

                <div class="code-block">
<span class="code-line"><span class="annotation">@OneToOne</span>(<span class="keyword">cascade</span> = <span class="keyword">CascadeType.ALL</span>) <span class="comment">// ‚Üê COMPOSICI√ìN</span></span>
<span class="code-line"><span class="keyword">private</span> Motor motor;</span>
                </div>

                <div class="success-box">
                    <strong>‚úÖ Tu caso Auto-Motor es COMPOSICI√ìN:</strong>
                    <ul>
                        <li>El Motor existe PARA el Auto</li>
                        <li>Si eliminas el Auto, el Motor tambi√©n se elimina</li>
                        <li>El Motor no tiene sentido sin su Auto</li>
                    </ul>
                </div>
            </div>

            <div class="section section-agregacion">
                <h3>2. AGREGACI√ìN (Aggregation) - "Usa/Tiene"</h3>
                <ul>
                    <li><strong>Dependencia d√©bil:</strong> El hijo PUEDE existir sin el padre</li>
                    <li><strong>Ciclo de vida independiente:</strong> Eliminar el padre NO elimina el hijo</li>
                    <li><strong>Propiedad compartida:</strong> El hijo puede pertenecer a varios padres</li>
                </ul>

                <div class="code-block">
<span class="code-line"><span class="annotation">@ManyToOne</span> <span class="comment">// ‚Üê AGREGACI√ìN</span></span>
<span class="code-line"><span class="annotation">@JoinColumn</span>(<span class="keyword">name</span> = <span class="keyword">"departamento_id"</span>)</span>
<span class="code-line"><span class="keyword">private</span> Departamento departamento;</span>
                </div>

                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Aspecto</th>
                            <th>COMPOSICI√ìN</th>
                            <th>AGREGACI√ìN</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>S√≠mbolo UML</strong></td>
                            <td>‚ô¶Ô∏è (rombo relleno)</td>
                            <td>‚ô¢ (rombo vac√≠o)</td>
                        </tr>
                        <tr>
                            <td><strong>Dependencia</strong></td>
                            <td>Fuerte</td>
                            <td>D√©bil</td>
                        </tr>
                        <tr>
                            <td><strong>Cascade</strong></td>
                            <td>CascadeType.ALL o REMOVE</td>
                            <td>Sin REMOVE</td>
                        </tr>
                        <tr>
                            <td><strong>Ejemplo</strong></td>
                            <td>Auto-Motor</td>
                            <td>Profesor-Estudiante</td>
                        </tr>
                        <tr>
                            <td><strong>Eliminaci√≥n</strong></td>
                            <td>Padre elimina ‚Üí Hijo elimina</td>
                            <td>Padre elimina ‚Üí Hijo persiste</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Secci√≥n: CascadeType -->
            <div class="section section-cascade">
                <h2><span class="emoji">‚ö°</span> Tipos de CascadeType</h2>
                
                <div class="cascade-grid">
                    <div class="cascade-item">
                        <h4>CascadeType.PERSIST</h4>
                        <p><strong>Qu√© hace:</strong> Cuando guardas el Auto, autom√°ticamente guarda el Motor</p>
                        <p><strong>Cu√°ndo:</strong> Para crear ambas entidades juntas</p>
                    </div>
                    
                    <div class="cascade-item">
                        <h4>CascadeType.MERGE</h4>
                        <p><strong>Qu√© hace:</strong> Cuando actualizas el Auto, tambi√©n actualiza el Motor</p>
                        <p><strong>Cu√°ndo:</strong> Para sincronizar cambios</p>
                    </div>
                    
                    <div class="cascade-item">
                        <h4>CascadeType.REMOVE</h4>
                        <p><strong>Qu√© hace:</strong> Cuando eliminas el Auto, tambi√©n elimina el Motor</p>
                        <p><strong>Cu√°ndo:</strong> Relaciones padre-hijo fuertes</p>
                    </div>
                    
                    <div class="cascade-item">
                        <h4>CascadeType.REFRESH</h4>
                        <p><strong>Qu√© hace:</strong> Refresca/recarga Auto Y Motor desde BD, descartando cambios en memoria</p>
                        <p><strong>Cu√°ndo:</strong> Cambios externos en BD, sincronizaci√≥n multi-usuario</p>
                    </div>
                    
                    <div class="cascade-item">
                        <h4>CascadeType.DETACH</h4>
                        <p><strong>Qu√© hace:</strong> Desconecta Auto Y Motor del EntityManager (no trackea cambios)</p>
                        <p><strong>Cu√°ndo:</strong> Optimizaci√≥n memoria, transferir entre contextos, evitar updates accidentales</p>
                    </div>
                    
                    <div class="cascade-item">
                        <h4>CascadeType.ALL ‚≠ê</h4>
                        <p><strong>Qu√© hace:</strong> Aplica TODOS los cascade anteriores</p>
                        <p><strong>Cu√°ndo:</strong> Relaciones fuertes (Auto-Motor)</p>
                    </div>
                </div>

                <div class="highlight-box">
                    <strong>üéØ Para tu caso Auto-Motor:</strong> <code>CascadeType.ALL</code> es perfecto porque:
                    <ul>
                        <li>PERSIST: Guarda motor autom√°ticamente</li>
                        <li>MERGE: Actualiza motor autom√°ticamente</li>
                        <li>REMOVE: Elimina motor cuando eliminas auto</li>
                    </ul>
                </div>
            </div>

            <!-- Secci√≥n: FetchType -->
            <div class="section section-fetch">
                <h2><span class="emoji">üöÄ</span> Tipos de FetchType</h2>
                
                <h3>FetchType.EAGER ‚ö° (Tu configuraci√≥n actual)</h3>
                <div class="success-box">
                    <ul>
                        <li><strong>Cu√°ndo carga:</strong> Al momento de cargar el Auto, autom√°ticamente carga el Motor</li>
                        <li><strong>Ventaja:</strong> Motor disponible inmediatamente, no hay LazyInitializationException</li>
                        <li><strong>Desventaja:</strong> Siempre carga datos que quiz√°s no uses</li>
                    </ul>
                </div>

                <div class="code-block">
<span class="comment">// SQL generado con EAGER:</span>
<span class="keyword">SELECT</span> a.*, m.* 
<span class="keyword">FROM</span> auto a 
<span class="keyword">LEFT JOIN</span> motor m <span class="keyword">ON</span> a.id_motor = m.idMotor 
<span class="keyword">WHERE</span> a.idAuto = 1
                </div>

                <h3>FetchType.LAZY üêå (Alternativa)</h3>
                <div class="error-box">
                    <ul>
                        <li><strong>Cu√°ndo carga:</strong> Solo cuando haces auto.getMotor()</li>
                        <li><strong>Ventaja:</strong> Mejor rendimiento si no siempre necesitas el motor</li>
                        <li><strong>Desventaja:</strong> Puede generar LazyInitializationException</li>
                        <li><strong>Requiere:</strong> @Transactional en m√©todos que acceden a propiedades lazy</li>
                    </ul>
                </div>

                <div class="highlight-box">
                    <strong>üéØ ¬øPor qu√© EAGER es bueno en tu caso?</strong>
                    <ul>
                        <li>‚úÖ Relaci√≥n fuerte: Auto sin motor no tiene mucho sentido</li>
                        <li>‚úÖ Uso frecuente: Probablemente siempre mostrar√°s datos del motor</li>
                        <li>‚úÖ Simplicidad: No te preocupas por LazyInitializationException</li>
                        <li>‚úÖ Rendimiento: Para OneToOne, el impacto es m√≠nimo</li>
                    </ul>
                </div>
            </div>

            <!-- Secci√≥n: REFRESH y DETACH Detallados -->
            <div class="section section-cascade">
                <h2><span class="emoji">üîÑ</span> CascadeType.REFRESH - Detallado</h2>
                
                <div class="error-box">
                    <h4>‚ùå REFRESH NO modifica la BD</h4>
                    <p>Es exactamente lo contrario: <strong>recarga datos desde BD hacia la aplicaci√≥n</strong></p>
                </div>

                <div class="success-box">
                    <h4>‚úÖ REFRESH s√≠ hace esto:</h4>
                    <ul>
                        <li>Refresca/Recarga datos desde BD hacia la aplicaci√≥n</li>
                        <li>Sincroniza el estado de la entidad con lo que est√° en BD</li>
                        <li>Descarta cambios no guardados en memoria</li>
                    </ul>
                </div>

                <h3>üîÑ Ejemplo pr√°ctico de REFRESH:</h3>
                <div class="code-block">
<span class="code-line"><span class="comment">// Situaci√≥n inicial</span></span>
<span class="code-line">Auto auto = autoRepository.findById(1L);</span>
<span class="code-line">System.out.println(auto.getMarca()); <span class="comment">// "Toyota"</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="comment">// 1. Modificas en memoria (SIN guardar)</span></span>
<span class="code-line">auto.setMarca(<span class="keyword">"Honda"</span>);</span>
<span class="code-line">System.out.println(auto.getMarca()); <span class="comment">// "Honda" (solo en memoria)</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="comment">// 2. Alguien M√ÅS modifica la BD externamente</span></span>
<span class="code-line"><span class="comment">// UPDATE auto SET marca = 'Nissan' WHERE idAuto = 1;</span></span>
<span class="code-line"><span class="comment">// UPDATE motor SET cilindrada = 2500 WHERE idMotor = auto.id_motor;</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="comment">// 3. Ejecutas refresh() - Con CascadeType.REFRESH</span></span>
<span class="code-line">entityManager.refresh(auto);</span>
<span class="code-line"></span>
<span class="code-line"><span class="comment">// 4. Resultado:</span></span>
<span class="code-line">System.out.println(auto.getMarca()); <span class="comment">// "Nissan" (desde BD, no "Honda")</span></span>
<span class="code-line">System.out.println(auto.getMotor().getCilindrada()); <span class="comment">// 2500 (tambi√©n refrescado)</span></span>
                </div>

                <div class="highlight-box">
                    <h4>üéØ Cu√°ndo usar REFRESH:</h4>
                    <ul>
                        <li><strong>Cambios externos en BD:</strong> Otros procesos, triggers, stored procedures</li>
                        <li><strong>Aplicaciones multi-usuario:</strong> Otros usuarios modifican datos</li>
                        <li><strong>Sincronizaci√≥n despu√©s de operaciones bulk</strong></li>
                        <li><strong>Descartar cambios no guardados</strong></li>
                    </ul>
                </div>

                <h3>‚ö†Ô∏è Cuidados con REFRESH:</h3>
                <div class="code-block">
<span class="code-line"><span class="comment">// 1. P√©rdida de cambios no guardados</span></span>
<span class="code-line">auto.setMarca(<span class="keyword">"BMW"</span>); <span class="comment">// Cambio en memoria</span></span>
<span class="code-line">entityManager.refresh(auto); <span class="comment">// ‚ùå Pierdes el cambio "BMW"</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="comment">// 2. Estado de relaciones</span></span>
<span class="code-line">Motor nuevoMotor = <span class="keyword">new</span> Motor(2000, <span class="keyword">"Volkswagen"</span>);</span>
<span class="code-line">auto.setMotor(nuevoMotor); <span class="comment">// Solo en memoria</span></span>
<span class="code-line">entityManager.refresh(auto); <span class="comment">// Motor vuelve al original de BD</span></span>
                </div>
            </div>

            <div class="section section-fetch">
                <h2><span class="emoji">üîå</span> CascadeType.DETACH - Detallado</h2>
                
                <div class="highlight-box">
                    <h4>üîå ¬øQu√© es DETACH?</h4>
                    <p><strong>DETACH desconecta una entidad del EntityManager</strong> (contexto de persistencia). La entidad sigue en memoria, pero JPA ya no la "vigila".</p>
                </div>

                <h3>üìä Estados de una entidad JPA:</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Estado</th>
                            <th>Descripci√≥n</th>
                            <th>Trackeo JPA</th>
                            <th>Cambios autom√°ticos</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>NEW/TRANSIENT</strong></td>
                            <td>Reci√©n creada, JPA no la conoce</td>
                            <td>‚ùå No</td>
                            <td>‚ùå No</td>
                        </tr>
                        <tr>
                            <td><strong>MANAGED/PERSISTENT</strong></td>
                            <td>JPA la trackea activamente</td>
                            <td>‚úÖ S√≠</td>
                            <td>‚úÖ Se sincronizan</td>
                        </tr>
                        <tr>
                            <td><strong>DETACHED</strong></td>
                            <td>Desconectada del contexto</td>
                            <td>‚ùå No</td>
                            <td>‚ùå NO se sincronizan</td>
                        </tr>
                        <tr>
                            <td><strong>REMOVED</strong></td>
                            <td>Marcada para eliminaci√≥n</td>
                            <td>‚úÖ S√≠</td>
                            <td>üóëÔ∏è Se elimina</td>
                        </tr>
                    </tbody>
                </table>

                <h3>üîå Ejemplo SIN CASCADE vs CON CASCADE:</h3>
                <div class="code-block">
<span class="code-line"><span class="comment">// SIN CascadeType.DETACH</span></span>
<span class="code-line"><span class="annotation">@OneToOne</span>(<span class="keyword">cascade</span> = {<span class="keyword">CascadeType.PERSIST</span>, <span class="keyword">CascadeType.MERGE</span>})</span>
<span class="code-line"><span class="keyword">private</span> Motor motor;</span>
<span class="code-line"></span>
<span class="code-line">entityManager.detach(auto); <span class="comment">// Solo Auto se detach, Motor sigue MANAGED</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="comment">// CON CascadeType.DETACH (incluido en ALL)</span></span>
<span class="code-line"><span class="annotation">@OneToOne</span>(<span class="keyword">cascade</span> = <span class="keyword">CascadeType.ALL</span>) <span class="comment">// Incluye DETACH</span></span>
<span class="code-line"><span class="keyword">private</span> Motor motor;</span>
<span class="code-line"></span>
<span class="code-line">entityManager.detach(auto); <span class="comment">// Auto Y Motor se detach autom√°ticamente</span></span>
                </div>

                <h3>üéØ Cu√°ndo usar DETACH:</h3>
                <div class="cascade-grid">
                    <div class="cascade-item">
                        <h4>1. Optimizaci√≥n de memoria</h4>
                        <p>Procesar muchas entidades sin mantenerlas en contexto</p>
                        <div class="code-block" style="font-size: 0.8rem; margin-top: 10px;">
<span class="code-line"><span class="keyword">for</span> (<span class="keyword">int</span> i = 0; i < 10000; i++) {</span>
<span class="code-line">    Auto auto = autoRepository.findById(i);</span>
<span class="code-line">    procesarDatos(auto);</span>
<span class="code-line">    entityManager.detach(auto); <span class="comment">// Libera memoria</span></span>
<span class="code-line">}</span>
                        </div>
                    </div>
                    
                    <div class="cascade-item">
                        <h4>2. Transferir entre contextos</h4>
                        <p>Usar entidades en diferentes transacciones</p>
                        <div class="code-block" style="font-size: 0.8rem; margin-top: 10px;">
<span class="code-line">entityManager.detach(auto);</span>
<span class="code-line"><span class="keyword">return</span> auto; <span class="comment">// Seguro para UI</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="comment">// M√°s tarde...</span></span>
<span class="code-line">Auto managed = entityManager.merge(auto);</span>
                        </div>
                    </div>
                    
                    <div class="cascade-item">
                        <h4>3. Evitar updates accidentales</h4>
                        <p>Pasar entidades a m√©todos no confiables</p>
                        <div class="code-block" style="font-size: 0.8rem; margin-top: 10px;">
<span class="code-line">entityManager.detach(auto);</span>
<span class="code-line">metodoExterno(auto); <span class="comment">// No afecta BD</span></span>
                        </div>
                    </div>
                </div>

                <div class="error-box">
                    <h4>‚ö†Ô∏è Problema com√∫n - LazyInitializationException:</h4>
                    <div class="code-block">
<span class="code-line"><span class="annotation">@Transactional</span></span>
<span class="code-line"><span class="keyword">public</span> Auto getAutoDetached(Long id) {</span>
<span class="code-line">    Auto auto = autoRepository.findById(id);</span>
<span class="code-line">    entityManager.detach(auto); <span class="comment">// Detach con motor LAZY</span></span>
<span class="code-line">    <span class="keyword">return</span> auto;</span>
<span class="code-line">}</span>
<span class="code-line"></span>
<span class="code-line"><span class="comment">// En otro lugar...</span></span>
<span class="code-line">Auto auto = autoService.getAutoDetached(1L);</span>
<span class="code-line">Motor motor = auto.getMotor(); <span class="comment">// ‚ùå LazyInitializationException!</span></span>
                    </div>
                    
                    <p><strong>Soluci√≥n:</strong> Forzar carga ANTES de detach o usar EAGER</p>
                </div>

                <div class="success-box">
                    <h4>‚úÖ M√©todos relacionados con DETACH:</h4>
                    <div class="code-block">
<span class="code-line"><span class="comment">// Detach una entidad espec√≠fica</span></span>
<span class="code-line">entityManager.detach(auto);</span>
<span class="code-line"></span>
<span class="code-line"><span class="comment">// Detach TODAS las entidades del contexto</span></span>
<span class="code-line">entityManager.clear();</span>
<span class="code-line"></span>
<span class="code-line"><span class="comment">// Verificar si est√° managed</span></span>
<span class="code-line"><span class="keyword">boolean</span> isManaged = entityManager.contains(auto);</span>
<span class="code-line"></span>
<span class="code-line"><span class="comment">// Re-attach una entidad detached</span></span>
<span class="code-line">Auto managedAuto = entityManager.merge(autoDetached);</span>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n: Comparaci√≥n REFRESH vs DETACH -->
            <div class="section">
                <h2><span class="emoji">‚öñÔ∏è</span> REFRESH vs DETACH - Comparaci√≥n</h2>
                
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Aspecto</th>
                            <th>CascadeType.REFRESH</th>
                            <th>CascadeType.DETACH</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Direcci√≥n</strong></td>
                            <td>BD ‚Üí App</td>
                            <td>Desconecta del contexto</td>
                        </tr>
                        <tr>
                            <td><strong>Prop√≥sito</strong></td>
                            <td>Sincronizar con cambios externos</td>
                            <td>Optimizar memoria/transferir contextos</td>
                        </tr>
                        <tr>
                            <td><strong>Cambios en memoria</strong></td>
                            <td>Se descartan</td>
                            <td>Se mantienen (pero no se trackean)</td>
                        </tr>
                        <tr>
                            <td><strong>Estado resultante</strong></td>
                            <td>MANAGED (actualizado)</td>
                            <td>DETACHED</td>
                        </tr>
                        <tr>
                            <td><strong>Uso com√∫n</strong></td>
                            <td>Multi-usuario, triggers BD</td>
                            <td>Batch processing, APIs</td>
                        </tr>
                    </tbody>
                </table>

                <div class="highlight-box">
                    <h4>üéØ Para tu proyecto Auto-Motor:</h4>
                    <p>Con <code>CascadeType.ALL</code> tienes ambos incluidos, pero probablemente:</p>
                    <ul>
                        <li><strong>REFRESH:</strong> Solo si otros procesos modifican autos/motores en BD</li>
                        <li><strong>DETACH:</strong> Raramente necesario para operaciones CRUD b√°sicas</li>
                        <li><strong>M√°s importantes:</strong> PERSIST, MERGE, REMOVE para tu caso de uso</li>
                    </ul>
                </div>
            </div>

            <!-- Secci√≥n: @Transactional -->
            <div class="section">
                <h2><span class="emoji">üîÑ</span> ¬øCu√°ndo necesitas @Transactional?</h2>
                
                <div class="success-box">
                    <h4>‚úÖ Con FetchType.EAGER (Tu caso) - NO necesitas @Transactional</h4>
                    <p>Porque el motor se carga inmediatamente junto con el auto en una sola consulta SQL.</p>
                </div>

                <div class="error-box">
                    <h4>‚ö†Ô∏è Con FetchType.LAZY - S√ç necesitas @Transactional</h4>
                    <p>Para evitar LazyInitializationException cuando accedes a propiedades del motor.</p>
                </div>

                <div class="code-block">
<span class="comment">// SIN @Transactional con LAZY - ‚ùå FALLA</span>
<span class="keyword">public</span> Auto getAutoConMotor(Long id) {
    Auto auto = autoRepository.findById(id); <span class="comment">// Conexi√≥n BD se cierra aqu√≠</span>
    Motor motor = auto.getMotor(); <span class="comment">// ‚ùå LazyInitializationException!</span>
    <span class="keyword">return</span> auto;
}

<span class="comment">// CON @Transactional - ‚úÖ FUNCIONA</span>
<span class="annotation">@Transactional</span>
<span class="keyword">public</span> Auto getAutoConMotor(Long id) {
    Auto auto = autoRepository.findById(id); 
    Motor motor = auto.getMotor(); <span class="comment">// ‚úÖ Sesi√≥n sigue abierta</span>
    <span class="keyword">return</span> auto;
}
                </div>
            </div>

            <!-- Secci√≥n: Ejemplos de Relaciones 1:1 -->
            <div class="section section-ejemplos">
                <h2><span class="emoji">üìö</span> Ejemplos de Relaciones OneToOne</h2>
                
                <h3>üîπ COMPOSICI√ìN (Como Auto-Motor)</h3>
                <div class="examples-grid">
                    <div class="example-card">
                        <h5>Persona ‚Üê Coraz√≥n</h5>
                        <p>Cada persona tiene un coraz√≥n espec√≠fico</p>
                    </div>
                    <div class="example-card">
                        <h5>Casa ‚Üê Direcci√≥n</h5>
                        <p>Cada casa tiene una direcci√≥n √∫nica</p>
                    </div>
                    <div class="example-card">
                        <h5>Producto ‚Üê CodigoBarras</h5>
                        <p>Cada producto tiene su c√≥digo √∫nico</p>
                    </div>
                    <div class="example-card">
                        <h5>Empleado ‚Üê Expediente</h5>
                        <p>Cada empleado tiene un expediente espec√≠fico</p>
                    </div>
                    <div class="example-card">
                        <h5>Pedido ‚Üê Factura</h5>
                        <p>Cada pedido genera una factura</p>
                    </div>
                    <div class="example-card">
                        <h5>Paciente ‚Üê HistoriaClinica</h5>
                        <p>Cada paciente tiene una historia cl√≠nica</p>
                    </div>
                </div>

                <h3>üîπ AGREGACI√ìN</h3>
                <div class="examples-grid">
                    <div class="example-card">
                        <h5>Empleado ‚Üê Oficina</h5>
                        <p>Un empleado puede tener una oficina asignada</p>
                    </div>
                    <div class="example-card">
                        <h5>Estudiante ‚Üê Casillero</h5>
                        <p>Estudiante puede tener un casillero asignado</p>
                    </div>
                    <div class="example-card">
                        <h5>Usuario ‚Üê Avatar</h5>
                        <p>Usuario puede tener un avatar reutilizable</p>
                    </div>
                    <div class="example-card">
                        <h5>M√©dico ‚Üê Consultorio</h5>
                        <p>M√©dico puede cambiar de consultorio</p>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n: Tu implementaci√≥n -->
            <div class="section">
                <h2><span class="emoji">üéØ</span> Tu implementaci√≥n Auto-Motor</h2>
                
                <div class="code-block">
<span class="comment">// Tu configuraci√≥n actual - PERFECTA para el caso de uso</span>
<span class="annotation">@OneToOne</span>(<span class="keyword">fetch</span> = <span class="keyword">FetchType.EAGER</span>, <span class="keyword">cascade</span> = <span class="keyword">CascadeType.ALL</span>)
<span class="annotation">@JoinColumn</span>(<span class="keyword">name</span> = <span class="keyword">"id_motor"</span>, <span class="keyword">referencedColumnName</span> = <span class="keyword">"idMotor"</span>)
<span class="keyword">private</span> Motor motor;
                </div>

                <div class="success-box">
                    <h4>‚úÖ Por qu√© tu implementaci√≥n es excelente:</h4>
                    <ul>
                        <li><strong>EAGER:</strong> Simple y directo, motor siempre disponible</li>
                        <li><strong>CascadeType.ALL:</strong> Operaciones autom√°ticas en motor</li>
                        <li><strong>Unidireccional:</strong> Auto conoce Motor, Motor no conoce Auto</li>
                        <li><strong>Composici√≥n:</strong> Motor existe para el Auto espec√≠fico</li>
                    </ul>
                </div>

                <h3>üóÉÔ∏è Esquema de Base de Datos generado:</h3>
                <div class="code-block">
<span class="comment">-- Tabla MOTOR (independiente)</span>
<span class="keyword">CREATE TABLE</span> motor (
    idMotor <span class="keyword">BIGINT AUTO_INCREMENT PRIMARY KEY</span>,
    cilindrada <span class="keyword">INT NOT NULL</span>,
    marca_motor <span class="keyword">VARCHAR</span>(255) <span class="keyword">NOT NULL</span>
);

<span class="comment">-- Tabla AUTO (con FK hacia motor)</span>
<span class="keyword">CREATE TABLE</span> auto (
    idAuto <span class="keyword">BIGINT AUTO_INCREMENT PRIMARY KEY</span>,
    marca <span class="keyword">VARCHAR</span>(255) <span class="keyword">NOT NULL</span>,
    modelo <span class="keyword">VARCHAR</span>(255) <span class="keyword">NOT NULL</span>,
    precio <span class="keyword">DECIMAL NOT NULL</span>,
    id_motor <span class="keyword">BIGINT</span>, <span class="comment">-- FK hacia motor.idMotor</span>
    <span class="keyword">CONSTRAINT</span> fk_auto_motor 
        <span class="keyword">FOREIGN KEY</span> (id_motor) <span class="keyword">REFERENCES</span> motor(idMotor)
);
                </div>
            </div>

            <!-- Secci√≥n: Equals y HashCode -->
            <div class="section">
                <h2><span class="emoji">‚öñÔ∏è</span> equals() y hashCode() en relaciones unidireccionales</h2>
                
                <div class="highlight-box">
                    <h4>‚ùì ¬øPor qu√© NO es obligatorio pero S√ç es buena pr√°ctica?</h4>
                    
                    <h5>NO es obligatorio porque:</h5>
                    <ul>
                        <li>No hay referencias circulares (Motor no conoce Auto)</li>
                        <li>Hibernate no necesita navegar hacia atr√°s</li>
                        <li>No hay riesgo de bucles infinitos</li>
                    </ul>

                    <h5>S√ç es buena pr√°ctica porque:</h5>
                    <ul>
                        <li>Consistencia con Collections de Java (HashSet, etc.)</li>
                        <li>Comparaciones en tests y l√≥gica de negocio</li>
                        <li>Prevenci√≥n de problemas futuros</li>
                    </ul>
                </div>

                <div class="code-block">
<span class="comment">// Tu implementaci√≥n correcta - usa solo el ID</span>
<span class="annotation">@Override</span>
<span class="keyword">public int</span> hashCode() {
    <span class="keyword">return</span> (idMotor == <span class="keyword">null</span>) ? 0 : idMotor.hashCode();
}

<span class="annotation">@Override</span>
<span class="keyword">public boolean</span> equals(Object obj) {
    <span class="comment">// ... comparaci√≥n por ID</span>
    <span class="keyword">return</span> idMotor.equals(other.idMotor);
}
                </div>
            </div>
        </div>
    </div>
</body>
</html>